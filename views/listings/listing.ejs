<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= listing.title %> - MeetMyHomes</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/listing.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap">
</head>
<body>
  <%- include('../partials/header') %>

  <div class="listing-container">
    <!-- Gallery Section -->
    <div class="gallery-section">
      <div class="thumbnail-grid">
        <% listing.images.slice(0, 5).forEach((image, index) => { %>
          <div class="grid-item">
            <img src="<%= image %>" 
                class="grid-thumb <%= index === 0 ? 'active' : '' %>"
                data-index="<%= index %>"
                alt="Thumbnail <%= index + 1 %>">
          </div>
        <% }); %>
        
        <% if (listing.images.length > 5) { %>
          <div class="grid-item see-more-container">
            <button class="see-more-btn" id="see-more-btn">
              <span>See More</span>
              <i class="fas fa-chevron-right"></i>
              <div class="photo-count">+<%= listing.images.length - 5 %></div>
            </button>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Photo Modal -->
    <%- include('../partials/photo-modal', {images: listing.images, listing: listing}) %>

    <!-- Basic Info Section -->
    <div class="listing-section">
      <h1><%= listing.title %></h1>
      <div class="property-meta">
        <span><i class="fas fa-map-marker-alt"></i> <%= listing.location %></span>
        <% if (listing.rating) { %>
          <span><i class="fas fa-star filled"></i> <%= listing.rating %></span>
        <% } %>
      </div>
      <div class="price-section">
        <span class="price"><%= listing.pricePerNight %></span>
        <span class="text-muted"> / night</span>
      </div>
    </div>

    <!-- Amenities Section -->
    <div class="listing-section">
      <h2>What this place offers</h2>
      <ul class="amenities arrow-list">
        <% listing.amenities.forEach(amenity => { %>
          <li><%= amenity %></li>
        <% }); %>
      </ul>
    </div>

    <!-- Description Section -->
    <div class="listing-section">
      <h2>About this place</h2>
      <div class="property-description">
        <% const paragraphs = listing.description.split('\n\n'); %>
        <% paragraphs.forEach(para => { %>
          <% if (para.startsWith('**') && para.endsWith('**')) { %>
            <h3 class="description-subheader"><%= para.replace(/\*\*/g, '') %></h3>
          <% } else if (para.startsWith('- ')) { %>
            <ul class="description-features">
              <% para.split('\n').forEach(item => { %>
                <li><%= item.replace('- ', '') %></li>
              <% }); %>
            </ul>
          <% } else { %>
            <p><%= para %></p>
          <% } %>
        <% }); %>
      </div>
    </div>

    <!-- Map Section -->
    <div class="listing-section">
      <h2>Location</h2>
      <div id="property-map"
          data-lat="<%= listing.coordinates.latitude %>"
          data-lng="<%= listing.coordinates.longitude %>"
          data-title="<%= listing.title %>">
        <div class="map-loading">Loading map...</div>
      </div>
      <a href="https://maps.google.com/maps?q=<%= listing.coordinates.latitude %>,<%= listing.coordinates.longitude %>"
        target="_blank"
        class="open-in-maps">
        <i class="fas fa-external-link-alt"></i> Open in Google Maps
      </a>
    </div>

    <!-- Host Section -->
    <div class="listing-section">
      <h2>Hosted by <%= listing.host.name %></h2>
      <div class="host-description">
        <div class="host-info">
          <% if (listing.host.superhost) { %>
            <p><span class="superhost-badge">Superhost</span> Â· Hosting since <%= listing.host.since %></p>
          <% } else { %>
            <p>Hosting since <%= listing.host.since %></p>
          <% } %>
          <p><%= listing.host.description %></p>
        </div>
        <% if (listing.host.image) { %>
          <img src="<%= listing.host.image %>" alt="<%= listing.host.name %>" class="host-image">
        <% } %>
      </div>
    </div>

    <!-- Reviews Section -->
    <% if (listing.reviews && listing.reviews.length > 0) { %>
      <div class="listing-section">
        <h2>Reviews</h2>
        <% listing.reviews.forEach(review => { %>
          <div class="review-card">
            <div class="review-header">
              <strong><%= review.author %></strong>
              <div class="review-rating">
                <% for (let i = 0; i < 5; i++) { %>
                  <i class="fas fa-star <%= i < review.rating ? 'filled' : '' %>"></i>
                <% } %>
              </div>
            </div>
            <p class="review-text">"<%= review.comment %>"</p>
            <p class="review-date text-muted">Reviewed on <%= review.date %></p>
          </div>
        <% }); %>
      </div>
    <% } %>

    <!-- House Rules Section -->
    <div class="listing-section">
      <h2>House Rules</h2>
      <ul class="house-rules arrow-list">
        <% listing.houseRules.forEach(rule => { %>
          <li>
            <% if (rule.toLowerCase().includes('smok')) { %>
              <i class="fas fa-smoking-ban"></i>
            <% } else if (rule.toLowerCase().includes('pet')) { %>
              <i class="fas fa-paw"></i>
            <% } else if (rule.toLowerCase().includes('check')) { %>
              <i class="fas fa-clock"></i>
            <% } else if (rule.toLowerCase().includes('guest')) { %>
              <i class="fas fa-users"></i>
            <% } %>
            <%= rule %>
          </li>
        <% }); %>
      </ul>
    </div>
  </div>

  <%- include('../partials/footer') %>

  <script src="/js/listing.js"></script>
</body>
</html>